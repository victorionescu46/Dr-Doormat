<?php
class Wdc_Checkout_Model_Cartdata extends Mage_Checkout_Model_Cart
{
	public function isGrain($productId)
	{
		$var = false;
		$readonce = Mage::getSingleton('core/resource')->getConnection('core_read');		
		$sql="SELECT * FROM sales_flat_quote_item a
				inner join catalog_product_entity b
				on a.product_id = b.entity_id
				where (b.attribute_set_id = 63) or (b.attribute_set_id = 66) and (a.row_weight < 50)
				and b.entity_id=".$productId;
		
		$result = $readonce->fetchRow($sql);
		
		if($result)
			{
			$var = true;	
			}	
			
		return $var;		
	}
	
	public function isGrainOrderId($item_id)
	{
		return $this->isGrain($this->_getProductIdOrder($item_id));	
	}
	
	public function _getProductIdOrder($item_id)
	{
		$pid = 0;
		$readonce = Mage::getSingleton('core/resource')->getConnection('core_read');
		$sql ="SELECT product_id FROM sales_flat_order_item where item_id =".$item_id;
		$result = $readonce->fetchRow($sql);
		if($result)
		{
			$pid = $result['product_id'];
		}		
		return $pid;
	}
	
	public function _containsNotCrush($itemId)
	{
		$crush = false;
		$readonce = Mage::getSingleton('core/resource')->getConnection('core_read');
		$sql="SELECT name FROM sales_flat_quote_item where (name like '%NOT CRUSH GRAIN%') and (item_id=".$itemId.")";	
		$result = $readonce->fetchRow($sql);
		if($result)
			{
			$crush = true;
			}		
		return $crush; 
	}
	
	public function _getCartRow($itemId)
	{
		$readonce = Mage::getSingleton('core/resource')->getConnection('core_read');
		$sql="SELECT item_id, quote_id, product_id, sku, name, qty, price, product_type FROM sales_flat_quote_item where item_id=".$itemId;	
		$row = $readonce->fetchRow($sql);	
		return $row;
	}
	
	protected function getProductId($itemId)
	{
		$row =  $this->_getCartRow($itemId);
		return $row['product_id'];	
	}
	
	public function updateCartDescGrain($itemId=257, $crush=false)
	{
		/*$productId = $this->getProductId($itemId);
		
		$product = new Wdc_Catalog_Model_Product();
		$productName = $product->_getProductName($productId);*/
		
		
		$productName = 'CRUSH THIS-->';
		if($crush)
		{
			$grain = "- Crush Grain";
		}
		else
		{
			$grain = "- DO NOT CRUSH GRAIN!";
		}
		
		$write = Mage::getSingleton('core/resource')->getConnection('core_write');
		//$sql = "update sales_flat_quote_item set name='".$productName.$grain."' where item_id=".$itemId;
		$sql = "update sales_flat_quote_item set name='This is so great and fantastic' where item_id=257";
		$write->query($sql);	
	}
	
	public function setCartOptions($item_id, $crush)
	{
		if(!$this->checkOptionExists($item_id))
		{
			$this->_insertCartOption($item_id);
		}	
		else
		{
			$this->_updateCartOption($item_id, $crush);	
		}
			
		//return $this->_getCartOptionLabel($item_id);
	}
	
	public function _getCartOptionLabel($item_id)
	{
		$var = 'Crushed';
		
		$readonce = Mage::getSingleton('core/resource')->getConnection('core_read');
		$sql="SELECT b.value FROM wdc_catalog_cart_options a ";
		$sql.="inner join wdc_catalog_cart_options_value b ";
		$sql.="on a.wdc_option_id = b.wdc_entity_id ";
		$sql.="where a.item_id =".$item_id;			
		$row = $readonce->fetchRow($sql);	
		
		if($row)
		{
			$var = $row['value'];
		}
				
		return $var;		
	}
	
	public function _getProductId($item_id)
	{
		$var = 0;
		$readonce = Mage::getSingleton('core/resource')->getConnection('core_read');
		$sql="SELECT product_id FROM sales_flat_quote_item where item_id =".$item_id;	
		$row = $readonce->fetchRow($sql);		
		if($row)
		{
			$var = $row['product_id'];	
		}		
		return $var;	
	}
	
	protected function _insertCartOption($item_id)
	{
		/**
		 * 1- Crushed
		 * 2- Not Crushed
		 * */
		if($item_id != 0)
		{			
			$write = Mage::getSingleton('core/resource')->getConnection('core_write');
			$sql = "insert into wdc_catalog_cart_options (wdc_option_id, item_id, product_id, cart_id) ";
			$sql.= "(select 2, item_id, product_id, quote_id from sales_flat_quote_item where item_id=".$item_id.")";
			$write->query($sql);	
		}	
	}
	
	protected function _updateCartOption($item_id, $crush)
	{
		if($crush == 'true')
			{
			$option = 1;		
			}
		else
			{
			$option = 2;	
			}
		$write = Mage::getSingleton('core/resource')->getConnection('core_write');
		$sql = "update wdc_catalog_cart_options set wdc_option_id=".$option." where item_id =".$item_id;
		$write->query($sql);		
	}
	
	public function checkOptionExists($item_id)
	{
		$var = false;
		$readonce = Mage::getSingleton('core/resource')->getConnection('core_read');
		$sql="SELECT wdc_option_id FROM wdc_catalog_cart_options where item_id=".$item_id;	
		$row = $readonce->fetchRow($sql);	
		
		if($row)
		{
			$var = $row['wdc_option_id'];	
		}
			
		return $var;			
	}
	
	public function _getQuoteItemId($item_id)
	{
	
		$var = 0;
		$readonce = Mage::getSingleton('core/resource')->getConnection('core_read');
		$sql="SELECT quote_item_id FROM sales_flat_order_item where item_id=".$item_id;	
		$row = $readonce->fetchRow($sql);	
		
		if($row)
		{
			$var = $row['quote_item_id'];	
		}
		
		return $var;	
	}
	
	
}

?>